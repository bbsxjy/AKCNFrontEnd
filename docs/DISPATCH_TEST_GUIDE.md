# 应用派发功能测试指南

## 功能概述

应用派发功能允许管理员将应用分配给开发或运维负责人，系统会自动：
1. 更新应用的负责人字段（`dev_owner` 或 `ops_owner`）
2. 更新该应用所有子任务的负责人字段
3. 发送系统通知给受派人
4. 受派人可在"我的任务"中查看新分配的任务

## 测试环境

### 当前用户信息
- **用户名**: 测试管理员
- **员工ID**: TEST001
- **角色**: Admin
- **Token**: `token_1_admin_full_access_test_2024` (固定测试token)

### Mock模式说明
当前派发功能运行在Mock模式下（`USE_MOCK = true`），前端直接调用API更新数据，无需后端派发接口。

## 完整测试流程

### 步骤1: 准备测试数据

#### 1.1 确保有测试应用
打开"应用管理"页面，确保至少有1-2个测试应用：
- 应用L2 ID: 任意
- 应用名称: 任意
- 确保应用有子任务（如果没有，先创建子任务）

#### 1.2 检查子任务
进入"子任务管理"，确认测试应用至少有1-2个子任务：
- 子任务状态：建议选择"研发进行中"或"业务上线中"（这些状态会显示在"我的任务"中）

### 步骤2: 执行派发操作

#### 2.1 选择应用
1. 在"应用管理"页面，勾选1个或多个应用
2. 点击页面右上角的"批量派发 (N)"按钮

#### 2.2 填写派发信息
在弹出的派发对话框中：

**派发方式**:
- 选择"开发负责人"或"运维负责人"
- 建议选择"开发负责人"（因为大部分子任务处于研发阶段）

**派发给**:
- 默认值: `测试管理员`（当前登录用户）
- 保持默认即可，也可以选择其他人员

**派发说明** (可选):
- 输入说明文字，如："请及时完成这些应用的开发工作"

**派发后操作**:
- 勾选"发送系统通知"（默认已勾选）

#### 2.3 确认派发
1. 检查派发摘要信息
2. 点击"确认派发"按钮
3. 等待处理完成

### 步骤3: 验证派发结果

#### 3.1 检查控制台日志

打开浏览器开发者工具（F12），查看Console标签页，应该看到类似日志：

```
🔧 使用Mock模式派发应用: {application_ids: Array(1), assignee_name: "测试管理员", ...}
🔄 正在派发应用: L2001 - 测试应用
✅ 已更新应用 L2001 的开发负责人为: 测试管理员
📋 应用 L2001 有 3 个子任务需要更新负责人
  ✅ 已更新子任务 v1.0 的开发负责人为: 测试管理员
  ✅ 已更新子任务 v1.1 的开发负责人为: 测试管理员
  ✅ 已更新子任务 v1.2 的开发负责人为: 测试管理员
🎉 派发完成: 成功更新 1 个应用，3 个子任务
✅ 已发送通知给 测试管理员
💡 提示: 测试管理员 可在"我的任务"页面查看新分配的任务
```

#### 3.2 检查成功提示

页面右上角应显示成功消息（绿色通知框）：
```
✅ 成功派发 1 个应用 | 👤 开发负责人: 测试管理员 | 📧 已发送系统通知
```

以及第二条提示：
```
派发成功！受派人可在"我的任务"中查看新分配的任务
```

#### 3.3 验证应用数据更新

1. 在"应用管理"页面，找到刚才派发的应用
2. 点击"编辑"查看详情
3. 确认以下字段已更新：
   - **开发负责人**: `测试管理员` (如果选择的是"开发负责人")
   - **运维负责人**: `测试管理员` (如果选择的是"运维负责人")

#### 3.4 验证子任务数据更新

1. 点击应用行的"查看子任务"按钮
2. 在子任务列表中，确认所有子任务的负责人已更新：
   - **开发负责人** 或 **运维负责人** = `测试管理员`

### 步骤4: 查看"我的任务"

#### 4.1 导航到"我的任务"页面
点击左侧菜单的"我的任务"

#### 4.2 方式A: 等待自动刷新（30秒）
页面会每30秒自动刷新任务列表，等待30秒后，新派发的任务应该出现。

#### 4.3 方式B: 手动刷新
点击页面右上角的"刷新"按钮，立即刷新任务列表。

#### 4.4 验证任务显示

确认以下内容：

**任务卡片**:
- 应该能看到刚才派发的应用的子任务
- 任务卡片显示：应用L2 ID、应用名称、子任务名称
- 状态标签正确（如"研发进行中"、"业务上线中"等）
- 进度条显示正确

**筛选标签**:
- 点击不同的筛选标签（全部、研发中、上线中等），任务应正确显示或隐藏
- "全部"标签后的数字应该增加

**紧急程度**:
- 如果计划完成时间在3天内，任务左侧应有橙色边框
- 如果已逾期，应有红色边框和"逾期 N 天"标签

### 步骤5: 查看通知

#### 5.1 检查通知提示框

在"我的任务"页面顶部，应该看到蓝色的通知提示框：

```
ℹ️ 您有 1 条新的任务派发通知

[通知内容区域]
**您有新的任务派发**
您被分配了 1 个应用的开发任务，请及时查看并填写进展。
[刚刚]

[标记已读] 按钮
```

#### 5.2 验证通知内容

通知应包含：
- 标题: "您有新的任务派发"
- 消息: 包含派发的应用数量和类型（开发/运维）
- 时间戳: 刚刚或几分钟前

#### 5.3 标记通知为已读

1. 点击通知项的"标记已读"按钮
2. 通知应从列表中消失
3. 页面顶部的通知数字应减少

#### 5.4 关闭通知提示框

点击通知提示框右上角的"×"关闭按钮，提示框应隐藏。

## 测试场景

### 场景1: 派发给开发负责人

**前提条件**: 有子任务处于"研发进行中"状态

**操作步骤**:
1. 选择应用
2. 派发方式选择"开发负责人"
3. 派发给"测试管理员"
4. 确认派发

**预期结果**:
- 应用的`dev_owner`字段更新为"测试管理员"
- 所有子任务的`dev_owner`字段更新为"测试管理员"
- 处于"研发进行中"的子任务在"我的任务"中显示

### 场景2: 派发给运维负责人

**前提条件**: 有子任务处于"业务上线中"状态

**操作步骤**:
1. 选择应用
2. 派发方式选择"运维负责人"
3. 派发给"测试管理员"
4. 确认派发

**预期结果**:
- 应用的`ops_owner`字段更新为"测试管理员"
- 所有子任务的`ops_owner`字段更新为"测试管理员"
- 处于"业务上线中"的子任务在"我的任务"中显示

### 场景3: 批量派发多个应用

**操作步骤**:
1. 同时选择3-5个应用
2. 执行派发操作
3. 查看控制台日志

**预期结果**:
- 所有应用都成功派发
- 控制台显示每个应用的处理日志
- 最后显示总计数字："成功更新 N 个应用，M 个子任务"

### 场景4: 派发说明传递

**操作步骤**:
1. 在"派发说明"框中输入自定义消息："紧急任务，请优先处理"
2. 完成派发
3. 查看通知内容

**预期结果**:
- 通知消息中包含自定义说明文字

## 常见问题排查

### Q1: 派发成功后，"我的任务"中看不到新任务

**可能原因**:
1. 等待时间不足（未满30秒自动刷新）
2. 子任务状态不是"研发进行中"或"业务上线中"
3. 派发类型与任务状态不匹配

**解决方法**:
1. 点击"刷新"按钮手动刷新
2. 检查子任务状态，确保是进行中的状态（非"待启动"或"已完成"）
3. 如果派发给开发负责人，确保子任务是"研发进行中"；如果派发给运维负责人，确保子任务是"业务上线中"

### Q2: 没有收到通知

**可能原因**:
1. 通知发送失败（检查控制台是否有错误日志）
2. 通知已被标记为已读
3. 通知API未正确实现

**解决方法**:
1. 检查浏览器Console，查找以"⚠️ 发送通知失败"开头的警告
2. 刷新页面，重新加载通知
3. 如果使用的是真实后端API，检查后端通知服务是否正常

### Q3: 控制台显示"⚠️ 更新应用 X 的子任务失败"

**可能原因**:
1. 应用没有子任务
2. 子任务API查询失败
3. 网络错误

**解决方法**:
1. 为该应用创建至少一个子任务
2. 检查Network标签，查看API请求是否成功
3. 重试派发操作

## 数据流程说明

### 派发操作数据流:

```
用户选择应用并点击"派发"
  ↓
DispatchDialog 显示派发表单
  ↓
用户填写信息并确认
  ↓
调用 DispatchAPI.dispatchApplications()
  ↓
[Mock模式] 对每个应用执行:
  1. ApplicationsAPI.updateApplication() - 更新应用负责人
  2. SubTasksAPI.getSubTasks() - 获取子任务列表
  3. SubTasksAPI.updateSubTask() - 逐个更新子任务负责人
  ↓
NotificationsAPI.sendNotification() - 发送通知
  ↓
返回成功结果
  ↓
显示成功提示
  ↓
刷新应用列表
```

### "我的任务"数据流:

```
MyTasksView 页面加载
  ↓
DashboardAPI.getMyTasks(currentUserName)
  ↓
SubTasksAPI.getMySubTasks() - 获取所有子任务
  ↓
过滤逻辑:
  - 排除已完成的任务
  - 根据任务状态和用户角色匹配:
    * 研发中 → 匹配 dev_owner
    * 上线中 → 匹配 ops_owner
    * 阻塞中 → 匹配 dev_owner 或 ops_owner
  ↓
按计划结束日期排序
  ↓
显示任务列表
```

### 通知数据流:

```
MyTasksView 页面加载
  ↓
loadDispatchNotifications()
  ↓
NotificationsAPI.getNotifications({unread_only: true})
  ↓
过滤 type === 'task_assignment'
  ↓
显示在页面顶部的通知提示框
  ↓
用户点击"标记已读"
  ↓
NotificationsAPI.markAsRead(id)
  ↓
重新加载通知列表
```

## 切换到真实后端API

当后端实现了派发接口后，需要修改 `src/api/dispatch.ts`:

```typescript
// 修改第21行
const USE_MOCK = false  // 改为 false 使用真实API
```

真实API应提供以下端点：
- `POST /api/v1/applications/dispatch`
  - 请求body: `{ application_ids, assignee_name, assignee_type, message }`
  - 响应: `{ success, failed, notification_sent, dispatched_applications }`

## 总结

完整的测试流程应包括：

1. ✅ 准备测试数据（应用和子任务）
2. ✅ 执行派发操作
3. ✅ 验证控制台日志输出
4. ✅ 确认应用和子任务数据更新
5. ✅ 在"我的任务"中查看新任务
6. ✅ 检查系统通知

所有步骤都应该能够顺利完成，并且数据能正确传递和显示。
